<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MAMMOTHS // OWNERS GRAPH</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Space Mono',monospace;background:#000;color:#0f0;height:100vh;overflow:hidden;text-transform:uppercase;letter-spacing:.05em}
.header{position:fixed;top:0;left:0;right:0;height:40px;border-bottom:1px solid #0f0;background:#000e;display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:3;font-size:11px}
.logo{font-weight:700;text-shadow:0 0 8px #0f0}
.left{position:fixed;top:40px;left:0;bottom:0;width:300px;border-right:1px solid #033;background:#000d;z-index:2;overflow:auto;padding:12px}
.mid{position:fixed;top:40px;left:300px;right:0;bottom:0}
#cv{position:absolute;inset:0;background:radial-gradient(ellipse at center,#001100 0%,#000 70%)}
h5{font-size:11px;color:#0a0;margin:10px 0 6px}
.input,button{width:100%;padding:8px;background:#000;border:1px solid #033;color:#0f0;font:10px 'Space Mono',monospace;outline:none}
button{cursor:pointer}
.row{display:flex;gap:8px}
.small{font-size:10px;color:#0c0}
.badge{border:1px solid #033;padding:2px 6px}
#tip{position:fixed;pointer-events:none;z-index:5;background:#020;border:1px solid #033;padding:3px 6px;font-size:10px;display:none}
</style>
</head>
<body>
<div class="header">
  <div class="logo">MAMMOTHS://OWNERS</div>
  <div class="small"><a href="/index.html" style="color:#0f0">TOKENS MAP</a></div>
  <div id="topstats" class="small"></div>
  </div>

<div class="left">
  <div id="status" class="small">Init...</div>

  <h5>Search</h5>
  <div class="row">
    <input id="searchWallet" class="input" placeholder="0x..."/>
    <button id="goWallet">Go</button>
  </div>
  <div class="row" style="margin-top:8px">
    <input id="searchId" class="input" type="number" placeholder="Token ID..."/>
    <button id="goId">Go</button>
  </div>

  <h5>Edges</h5>
  <div class="row">
    <button id="toggleEdges">Show Edges</button>
  </div>
  <div class="small">Max edges per wallet <span id="edgeCapVal" class="badge">8</span></div>
  <input id="edgeCap" type="range" min="1" max="30" value="8"/>
</div>

<div class="mid" id="mid"><canvas id="cv"></canvas></div>

<div id="tip"></div>

<script>
const cv = document.getElementById('cv');
const mid = document.getElementById('mid');
const ctx = cv.getContext('2d', { alpha:false });
const tip = document.getElementById('tip');

let DPR=1,W=0,H=0, zoom=1, ox=0, oy=0, dragging=false, lx=0, ly=0;
let nodes=[], wallets=[], tokens=[], edges=[], idToNode=new Map(), walletToNode=new Map();
let showEdges=false, edgeCap=8;

function sizeCanvas(){
  const r=mid.getBoundingClientRect();
  DPR=Math.min(window.devicePixelRatio||1,1.75);
  cv.width=Math.floor(r.width*DPR); cv.height=Math.floor(r.height*DPR);
  W=r.width; H=r.height; ctx.setTransform(1,0,0,1,0,0); ctx.scale(DPR,DPR);
  draw();
}
new ResizeObserver(sizeCanvas).observe(mid);

let dot, dotWallet;
function makeDots(){
  const s=18, off=document.createElement('canvas'); off.width=off.height=s;
  const g=off.getContext('2d'), R=s/2; let grd=g.createRadialGradient(R,R,0,R,R,R);
  grd.addColorStop(0,'#bfff9f'); grd.addColorStop(1,'rgba(0,0,0,0)');
  g.fillStyle=grd; g.beginPath(); g.arc(R,R,R,0,Math.PI*2); g.fill(); dot=off;
  const off2=document.createElement('canvas'); off2.width=off2.height=s*1.6; const g2=off2.getContext('2d'), R2=off2.width/2; grd=g2.createRadialGradient(R2,R2,0,R2,R2,R2);
  grd.addColorStop(0,'#aaffff'); grd.addColorStop(1,'rgba(0,0,0,0)'); g2.fillStyle=grd; g2.beginPath(); g2.arc(R2,R2,R2,0,Math.PI*2); g2.fill(); dotWallet=off2;
}

function hashHue(s){ let h=0; for(let i=0;i<s.length;i++) h=(h*31 + s.charCodeAt(i))>>>0; return h%360; }
function colorForTrait(val){ if(!val) return '#22dd22'; const h=hashHue(val); return `hsl(${h}, 90%, 60%)`; }

function layoutGraph(){
  // wallets around inner ring sized by holdCount
  wallets.sort((a,b)=>b.holdCount-a.holdCount);
  const n=wallets.length; const Rmin=Math.min(W,H)*0.18; const Rmax=Math.min(W,H)*0.35;
  for(let i=0;i<n;i++){
    const t=i/n*2*Math.PI; const r=Rmin + (i/n)*(Rmax-Rmin);
    const w=wallets[i]; w.x=Math.cos(t)*r; w.y=Math.sin(t)*r; w.radius=6+Math.min(24, Math.sqrt(w.holdCount));
  }
  // tokens near their owner
  for(const t of tokens){ const w = walletToNode.get(t.owner); if(!w){ t.x=(Math.random()-0.5)*W*0.4; t.y=(Math.random()-0.5)*H*0.4; continue; }
    const ang=Math.random()*Math.PI*2; const dist=30+Math.random()*40; t.x=w.x+Math.cos(ang)*dist; t.y=w.y+Math.sin(ang)*dist; t.radius=3; t.fill=colorForTrait(t.trait?.body||''); }
}

function draw(){
  ctx.clearRect(0,0,W,H);
  ctx.save(); ctx.translate(W/2,H/2); ctx.scale(zoom,zoom); ctx.translate(ox,oy);
  if(showEdges){ ctx.lineWidth=1; ctx.strokeStyle='rgba(0,255,0,0.15)'; ctx.beginPath();
    let drawn=0; for (const e of edges){ if (drawn>edgeCap*wallets.length) break; const a=e._a, b=e._b; ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); drawn++; } ctx.stroke(); }
  for(const w of wallets){ ctx.drawImage(dotWallet, w.x-w.radius, w.y-w.radius, w.radius*2, w.radius*2); }
  for(const t of tokens){ ctx.fillStyle=t.fill||'#22dd22'; const r=3; ctx.drawImage(dot, t.x-r/2, t.y-r/2, r, r); }
  ctx.restore();
}

function dist(a,b,x,y){ const d=Math.hypot(x-a,y-b); return d; }

cv.addEventListener('mousemove', e=>{
  const rect=cv.getBoundingClientRect(), mx=(e.clientX-rect.left), my=(e.clientY-rect.top);
  const wx=(mx - W/2)/zoom - ox, wy=(my - H/2)/zoom - oy;
  let best=null, bestD=22, type='';
  for(const w of wallets){ const d=dist(w.x,w.y,wx,wy); if(d<bestD){best=w; bestD=d; type='wallet';} }
  for(const t of tokens){ const d=dist(t.x,t.y,wx,wy); if(d<bestD){best=t; bestD=d; type='token';} }
  if(best){ tip.style.left=(e.clientX+12)+'px'; tip.style.top=(e.clientY+12)+'px'; tip.textContent= type==='wallet' ? best.id : ('#'+best.mid); tip.style.display='block'; }
  else tip.style.display='none';
});

cv.addEventListener('click', async e=>{
  const rect=cv.getBoundingClientRect(), mx=(e.clientX-rect.left), my=(e.clientY-rect.top);
  const wx=(mx - W/2)/zoom - ox, wy=(my - H/2)/zoom - oy;
  let best=null, bestD=22, type='';
  for(const w of wallets){ const d=dist(w.x,w.y,wx,wy); if(d<bestD){best=w; bestD=d; type='wallet';} }
  for(const t of tokens){ const d=dist(t.x,t.y,wx,wy); if(d<bestD){best=t; bestD=d; type='token';} }
  if(!best) return;
  if(type==='token'){
    const t = await fetch('/api/token/'+best.mid).then(r=>r.json()).catch(()=>null);
    if(t && t.tokenMetadata){ const img=t.tokenMetadata.image || t.tokenMetadata.fullImage || ''; window.open(img, '_blank'); }
  } else {
    // center on wallet
    ox = -best.x; oy = -best.y; zoom = 1.8; draw();
  }
});

cv.addEventListener('mousedown', e=>{ dragging=true; lx=e.clientX; ly=e.clientY; });
addEventListener('mouseup', ()=> dragging=false);
addEventListener('mousemove', e=>{ if(!dragging)return; const dx=(e.clientX-lx)/zoom, dy=(e.clientY-ly)/zoom; ox+=dx; oy+=dy; lx=e.clientX; ly=e.clientY; draw(); });
cv.addEventListener('wheel', e=>{ const k=e.deltaY<0?1.1:0.9; zoom=Math.max(0.2,Math.min(zoom*k,5)); draw(); });

document.getElementById('toggleEdges').onclick=()=>{ showEdges=!showEdges; document.getElementById('toggleEdges').textContent = showEdges ? 'Hide Edges' : 'Show Edges'; draw(); };
document.getElementById('edgeCap').oninput=e=>{ edgeCap=Number(e.target.value); document.getElementById('edgeCapVal').textContent=String(edgeCap); draw(); };
document.getElementById('goWallet').onclick=()=>{ const a=String(document.getElementById('searchWallet').value||'').toLowerCase(); const n=walletToNode.get(a); if(!n) return; ox=-n.x; oy=-n.y; zoom=2; draw(); };
document.getElementById('goId').onclick=()=>{ const id=Number(document.getElementById('searchId').value); const n=idToNode.get(id); if(!n) return; ox=-n.x; oy=-n.y; zoom=2; draw(); };

(async function boot(){
  document.getElementById('status').textContent='Loading owners graph...';
  makeDots(); sizeCanvas();
  const g = await fetch('/api/owners-graph').then(r=>r.json());
  const all = g.nodes;
  wallets = all.filter(n=>n.kind==='wallet');
  tokens  = all.filter(n=>n.kind==='mammoth');
  for(const w of wallets){ walletToNode.set(w.id, w); }
  for(const t of tokens){ idToNode.set(t.mid, t); t.fill = colorForTrait(t.trait?.body||''); }
  edges = g.edges.map(e=>({ ...e, _a: walletToNode.get(e.source), _b: idToNode.get(Number(String(e.target).slice(2))) || null })).filter(x=>x._a && x._b);
  layoutGraph(); draw();
  document.getElementById('status').textContent=`Wallets ${wallets.length}  |  Tokens ${tokens.length}`;
})();
</script>
</body>
</html>

